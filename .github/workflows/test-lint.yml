name: test and lint

on:
  workflow_call:
    
jobs:
  python:
    name: python
    runs-on: ubuntu-latest
    env:
      COMPOSE_FILE: docker-compose-deploy.yaml
    steps:
      - uses: actions/checkout@v4
      - name: test
        env:
          DJANGO_SECRET_KEY: ${{ secrets.DJANGO_SECRET_KEY }}
          DB_PASS: ${{ secrets.DB_PASS }}
          DB_USER: ${{ vars.DB_USER }}
          DB_NAME: ${{ vars.DB_NAME }}
          DB_PORT: 5432
        run: |
          cd backend
          docker compose -f $COMPOSE_FILE run --rm api sh -c "python manage.py wait_for_db && python manage.py test"
      - name: flake8
        run: |
          cd backend
          docker compose -f $COMPOSE_FILE run --rm api flake8

  terraform:
    name: terraform
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: terraform format & validation
        run: |
          cd infra
          docker compose run --rm tf -chdir=setup init -backend=false
          docker compose run --rm tf -chdir=deploy init -backend=false
          docker compose run --rm tf -chdir=setup fmt -check
          docker compose run --rm tf -chdir=deploy fmt -check
          docker compose run --rm tf -chdir=setup validate
          docker compose run --rm tf -chdir=deploy validate
